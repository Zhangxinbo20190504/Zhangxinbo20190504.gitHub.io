I"™5<h3 id="é—®é¢˜å¯¼å…¥">é—®é¢˜å¯¼å…¥</h3>

<ul>
  <li>å¦‚ä½•å°†ä¸€å°é¡¹ç›®åˆ†é…çš„äº‘è™šæœºå¿«é€Ÿéƒ¨ç½²ä¸ºå¯ç”¨æ„å»ºç¯å¢ƒ</li>
  <li>å¦‚ä½•å°†ä¸€ç»„é¡¹ç›®åˆ†é…çš„äº‘è™šæœºå¿«é€Ÿéƒ¨ç½²ä¸ºå¯ç”¨æ„å»ºç¯å¢ƒ</li>
  <li>å¦‚ä½•ç›‘æ§ä¸€ç»„æœºå™¨çš„çŠ¶æ€</li>
</ul>

<h3 id="ä¸ºä»€ä¹ˆé€‰æ‹©ansible">ä¸ºä»€ä¹ˆé€‰æ‹©ansible</h3>

<ul>
  <li>
    <p>è¯­æ³•ç®€å•</p>

    <p>é…ç½®ç®¡ç†è„šæœ¬ä½¿ç”¨YAMLè¯­æ³•ï¼Œäººç±»å¯è¯»çš„å­—å…¸ç»“æ„
è½»é‡çº§çš„æŠ½è±¡ï¼Œå¹¶ä¸éœ€è¦å­¦ä¹ é¢å¤–çš„æŠ½è±¡è¯­æ³•</p>
  </li>
  <li>
    <p>æœ€å°‘çš„ä¾èµ–</p>

    <p>åªéœ€è¦åœ¨æ§åˆ¶æœåŠ¡å™¨ä¸Šé…ç½®
å—æ§æœºä»…éœ€å®‰è£…sshå’Œpython&gt;2.5ï¼Œlinuxä¸»æœºå¤§å¤šå·²é¢„è£…</p>
  </li>
  <li>
    <p>åŠŸèƒ½å¼ºå¤§</p>

    <p>å†…ç½®å¤§é‡æ¨¡å—ï¼Œè¶³ä»¥å®Œæˆæ—¥å¸¸éœ€æ±‚
å¹‚ç­‰æ€§ï¼Œé‡å¤æ‰§è¡Œå®‰å…¨</p>
  </li>
</ul>

<blockquote>
  <p>ç¯å¢ƒ ubuntu16.04</p>
</blockquote>

<h3 id="ansibleé…ç½®">Ansibleé…ç½®</h3>

<blockquote>
  <p>ä¹Ÿå¯ä»¥ä½¿ç”¨æºç å®‰è£…ï¼Œå¯ä»¥ä½¿ç”¨æœ€æ–°åŠŸèƒ½ <a href="https://github.com/ansible/ansible">ansibleå®˜æ–¹gitbub</a></p>
</blockquote>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>apt <span class="nb">install </span>ansible
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ansibleé…ç½®æ–‡ä»¶å¦‚ä¸‹</p>

<ul>
  <li>ansible.cfgï¼šansibleé…ç½®æ–‡ä»¶</li>
  <li>hostï¼šä¸»æœºä¿¡æ¯é…ç½®æ–‡ä»¶ï¼Œé€šå¸¸å«åšinventoryæ–‡ä»¶</li>
  <li>*.ymlï¼šplaybookæ–‡ä»¶ï¼Œæ‰§è¡Œå‘½ä»¤é…ç½®æ–‡ä»¶</li>
</ul>

<p>Ansible é…ç½®æ–‡ä»¶è¯»å–é¡ºåºå¦‚ä¸‹</p>

<p>ANSIBLE_CONFIGç¯å¢ƒå˜é‡æŒ‡å®šçš„æ–‡ä»¶</p>

<p>./ansible.cfg(å½“å‰ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶)
~/.ansible.cfg(ä¸»ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶)</p>

<p>/etc/ansible/ansible.cfg(å®‰è£…é»˜è®¤é…ç½®æ–‡ä»¶)</p>

<p>ä¸»è¦é…ç½®é¡¹å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>inventory = host       # inventoryæ–‡ä»¶è·¯å¾„ 
remote_tmp = /tmp/.ansible/tmp    # é»˜è®¤ $HOME/.ansible/tmp, ä¿®æ”¹ï¼Œé˜²æ­¢æ²¡æœ‰æƒé™åˆ›å»º$HOME	   
host_key_checking = False      # ä½¿ç”¨ç”¨æˆ·åå¯†ç ç™»å½•æ—¶å…³é—­ä¸»æœºç§˜é’¥éªŒè¯
pipelining = True    # å¼€å¯æµæ°´çº¿ï¼Œä¸éœ€è¦å¤åˆ¶è„šæœ¬ç›´æ¥åˆ©ç”¨sshç®¡é“æ‰§è¡Œpythonè„šæœ¬ï¼Œä¼˜åŒ–
ssh_args = -o ControlMaster=auto -o ControlPersist=60s # å¼€å¯sshå¤šè·¯å¤ç”¨ï¼ˆé•¿è¿æ¥ä¿æŒï¼‰ï¼Œä¼˜åŒ–

</pre></td></tr></tbody></table></code></pre></div></div>

<p>hostæ–‡ä»¶æ ·ä¾‹</p>

<blockquote>
  <p>ansible_become_passé…ç½®rootå¯†ç ï¼Œæ—§ç‰ˆæœ¬ä¸­å¯èƒ½ä¸ºansible_su_pass</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>[init_disk]             # ç»„å
10.7.225.33 ansible_ssh_user=szdev ansible_ssh_pass=szdev ansible_become_pass=szdev    # ä¸»æœºååŠå‚æ•°
10.7.225.34 ansible_ssh_user=szdev ansible_ssh_pass=szdev ansible_become_pass=szdev
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä¸ºäº†ä¸€ç»„ç›¸åŒä¸»æœºç”¨æˆ·åå’Œå¯†ç ï¼Œæ¨èä¸‹é¢çš„å†™æ³•</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>[virtual:vars]        # ä¸ºç»„è®¾ç½®å˜é‡
ansible_ssh_user=szdev
ansible_ssh_pass=XXXXXX
ansible_become_pass=XXXXXX

[virtual:children]    # ç»§æ‰¿å…³ç³»
init_4g_v
check_disk_use

[init_4g_v]
10.7.225.218

</pre></td></tr></tbody></table></code></pre></div></div>

<p>é…ç½®å¥½cfgå’Œhostæ–‡ä»¶ä¹‹åï¼Œå°±å¯ä»¥å¼€å‘ä½¿ç”¨äº†</p>

<ul>
  <li>
    <p>éªŒè¯æ˜¯å¦é“¾æ¥</p>

    <p>ansible <group_name> -m <model_name></model_name></group_name></p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>ansible init_4g_v <span class="nt">-m</span> ping
10.7.225.216 | SUCCESS <span class="o">=&gt;</span> <span class="o">{</span>
    <span class="s2">"changed"</span>: <span class="nb">false</span>,
    <span class="s2">"ping"</span>: <span class="s2">"pong"</span>
<span class="o">}</span> 
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>
    <p>æ‰§è¡Œshellå‘½ä»¤</p>

    <p>ansible <group_name> -m <model_name>  -a <args></args></model_name></group_name></p>

    <blockquote>
      <p>commandä¸ºé»˜è®¤æ¨¡å—ï¼Œå¯ä»¥çœç•¥</p>
    </blockquote>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>ansible init_4g_v <span class="o">(</span><span class="nt">-m</span> <span class="nb">command</span><span class="o">)</span> <span class="nt">-a</span> <span class="s1">'echo helloworld'</span>
  
10.7.225.216 | SUCCESS | <span class="nv">rc</span><span class="o">=</span>0 <span class="o">&gt;&gt;</span>
helloworld
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
</ul>

<h3 id="playbook">playbook</h3>

<p>playbookæŠŠä¸€ç»„ansibleå‘½ä»¤å†™æˆäº†ä¸€ä¸ªæ–‡ä»¶æ‰§è¡Œ</p>

<p>playbookåŸºç¡€æ ·ä¾‹å¦‚ä¸‹</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>- name: Init Disks   # ä¸€ç»„ä»»åŠ¡çš„åå­—
  hosts: init_disk   # å¿…å¡«é¡¹ï¼šä¸»æœºç»„å
  become: True       # æ˜¯å¦ç”¨rootæ‰§è¡Œï¼Œå¯¹Ubuntuéå¸¸æœ‰ç”¨
  vars:              # ä¸€ç»„ä»»åŠ¡ç”¨åˆ°çš„å˜é‡ï¼Œå¯ç›´æ¥ç”¨è°ƒç”¨
  tasks:             # å¿…å¡«é¡¹ï¼štaskä»»åŠ¡åˆ—è¡¨
  - name: Change szdev Password
    user: name=szdev password=XXXXXX    

  - name: Change root Password
    user: name=root password=XXXXXX
    ignore_errors: True
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æŸ¥çœ‹Ansibleæ‰€æœ‰æ¨¡å—ï¼šansible-doc -l</p>

<p>æŸ¥çœ‹æŸå…·ä½“æ¨¡å—è¯´æ˜ï¼šansible-doc <model></model></p>

<p>è¿è¡Œplaybookï¼š ansible-playbook XXX.yml</p>

<p>ä»æŸä¸ªä»»åŠ¡å¼€å§‹æ‰§è¡Œplaybookï¼š</p>

<p>ansible-playbook â€“start-at-task <task name=""> XXX.yml</task></p>

<p>ä¸¾ä¾‹ä»‹ç»å‡ ä¸ªplaybookå¸¸ç”¨æ¨¡å—</p>

<h4 id="aptæ¨¡å—">aptæ¨¡å—</h4>

<blockquote>
  <p>ç”¨äºå®‰è£…è½¯ä»¶</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>- name: Install software
  apt: pkg=ccache update_cache=yes    cache_valid_time=3600
- name: Install software
   apt: pkg= update_cache=yes cache_valid_time=3600
   with_items:
        - curl
        - ccache
        - distcc
        - docker.io
        - expect
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="mountæ¨¡å—">mountæ¨¡å—</h4>

<blockquote>
  <p>ç”¨äºæŒ‚è½½</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>- name: Mount result server
  mount:
       name: /home/ci/result
       src: //10.11.134.78/ItranBuildingResult
       fstype: cifs
       opts: username=CI,password=Ci123456
       state: mounted

</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="gitæ¨¡å—">gitæ¨¡å—</h4>

<blockquote>
  <p>ä¸‹è½½ä»£ç </p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>- name: Clone base CI config sript
      git: repo=&lt;your git server&gt;/it-ran/ci/ dest=/home/node_0/workspace/ci/ 
      with_items:
        - config
        - script
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="åº”ç”¨æ‹·è´sshé…ç½®å¹¶é‡å¯sshæœåŠ¡">åº”ç”¨ï¼šæ‹·è´sshé…ç½®å¹¶é‡å¯sshæœåŠ¡</h4>

<blockquote>
  <p>copyæ¨¡å—ï¼šå°†æ–‡ä»¶ä»æœ¬åœ°å¤åˆ¶åˆ°è¿œç¨‹ä¸»æœº</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>- name: Sync sshd config
   copy:
      src: /etc/ssh/sshd_config
      dest: /etc/ssh/

- name: Restart ssh service
  service: name=sshd   state=restarted
  ignore_errors: True
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿˜æœ‰å¦ä¸€ç§å†™æ³•</p>

<blockquote>
  <p>å…³äºnotifyå’Œhandlerï¼š</p>

  <ul>
    <li>handleræ˜¯Ansibleæä¾›çš„æ¡ä»¶æ§åˆ¶æœºåˆ¶ï¼Œåªæœ‰è¢«taské€šçŸ¥æ‰æ‰§è¡Œ</li>
    <li>handleråªä¼šåœ¨æ‰€æœ‰taskæ‰§è¡Œå®Œä¹‹åæ‰æ‰§è¡Œï¼Œä¸”ä¸ç®¡é€šçŸ¥å¤šå°‘æ¬¡ï¼Œåªæ‰§è¡Œä¸€æ¬¡</li>
    <li>handleræŒ‰ç…§å®šä¹‰çš„é¡ºåºæ‰§è¡Œè€Œä¸æ˜¯é€šçŸ¥çš„é¡ºåº</li>
    <li>handleræœ€å¸¸ç”¨çš„åŠŸèƒ½å°±æ˜¯é‡å¯æœåŠ¡</li>
  </ul>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>tasks:
    - name: Sync sshd config
      copy:
        src: /etc/ssh/sshd_config
        dest: /etc/ssh/
      notify: restart sshd service
 handlers:
    - name: restart sshd service
      service: name=sshd state=restarted
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="åº”ç”¨registerå˜é‡">åº”ç”¨ï¼šregisterå˜é‡</h4>

<blockquote>
  <p>registerï¼šæ•è·å‘½ä»¤è¾“å‡ºåˆ°å˜é‡
debugï¼šè¾“å‡º</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>- name: Init Build ENV PLAT BUILD
  hosts: init_4g_v
  become: True
  vars:
  tasks:
    - name: check who am i
      command: whoami
      register: result
    - debug: var=result
    - debug: msg="Current user is "
</pre></td></tr></tbody></table></code></pre></div></div>

<p>result è¾“å‡ºå¦‚ä¸‹</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre>ok: [10.7.216.20] =&gt; {
    "result": {
        "changed": true,                       # changedï¼šä¸»æœºçŠ¶æ€æ˜¯å¦å‘ç”Ÿæ”¹å˜
        "cmd": [
            "whoami"                           # cmdï¼šæ¨¡å—å‚æ•°
        ],
        "delta": "0:00:00.003337",
        "end": "2019-03-28 20:21:34.893271",
        "failed": false,
        "rc": 0,                               # rcï¼šæ‰§è¡Œè¿”å›å€¼ï¼Œ0æˆåŠŸ é0å¤±è´¥
        "start": "2019-03-28 20:21:34.889934",
        "stderr": "",                          # stderrï¼šé”™è¯¯è¾“å‡º
        "stderr_lines": [],
        "stdout": "root",                      # stdoutï¼šæ ‡å‡†è¾“å‡º
        "stdout_lines": [                      # stdout_linesï¼šæ¢è¡Œç¬¦åˆ†å‰²åçš„æ ‡å‡†è¾“å‡º
            "root"
        ]
    }
}
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="åº”ç”¨ä½¿ç”¨whenåŒºåˆ«æ“ä½œ">åº”ç”¨ï¼šä½¿ç”¨whenåŒºåˆ«æ“ä½œ</h4>

<blockquote>
  <p>ç±»ä¼¼ä»£ç è®¾è®¡é‡Œçš„ if å…³é”®å­—</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>- name: test
  hosts: init_4g_v
  become: True
  vars:
  tasks:
    - name: check folder
      command: ls /home/sdb1/ItranBuildingResult
      register: result
      ignore_errors: True
    
    - name: install software
      apt: pkg=samba update_cache=yes    
      when: result is succeeded
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="æ”¶ç›Šansibleèƒ½å¸¦æ¥ä»€ä¹ˆ">æ”¶ç›Šï¼šansibleèƒ½å¸¦æ¥ä»€ä¹ˆ</h3>

<ul>
  <li>
    <p>æ‰¹é‡æ‰§è¡Œã€éƒ¨ç½²ã€æ ‡å‡†åŒ–å»ºè®¾</p>

    <p>éƒ¨ç½²æ–°æœºå™¨ä½œä¸ºæ„å»ºæœº</p>

    <p>ç°æœ‰æ„å»ºç¯å¢ƒçš„å‡çº§ï¼ˆå¦‚å·¥å…·é“¾å‡çº§ï¼‰</p>
  </li>
  <li>
    <p>æœºå™¨çŠ¶æ€ç›‘æ§</p>

    <p>æ‰¹é‡æœºå™¨çš„ç›‘æ§ï¼Œä¿è¯æœºå™¨çŠ¶æ€ï¼ˆå¦‚ ç£ç›˜ç©ºé—´ç­‰ï¼‰å¤„äºæ­£å¸¸çŠ¶æ€</p>
  </li>
  <li>
    <p>æºç å­¦ä¹ </p>

    <p>AnsibleåŸºäºpythonå¼€å‘ï¼Œä¸”è¿è¡ŒåŸºäºyamlé…ç½®æ–‡ä»¶ï¼Œä¸å½“å‰CIæ„å»ºå¤§è‡´ç›¸åŒï¼Œå¯ä»¥é€šè¿‡å­¦ä¹ æºç æå‡è‡ªå·±çš„èƒ½åŠ›</p>
  </li>
</ul>

<h3 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h3>

<ul>
  <li><a href="https://docs.ansible.com/">å®˜æ–¹æ–‡æ¡£</a></li>
  <li><a href="http://www.ansible.com.cn/">ä¸­æ–‡ç‰ˆæ–‡æ¡£</a></li>
  <li><a href="https://www.cnblogs.com/saneri/p/8487973.html">python3 + Ansible é€šç”¨æ¥å£å®ç°</a></li>
  <li>å¥”è·‘å§Ansibleã€‹ç”µå­å·¥ä¸šå‡ºç‰ˆç¤¾</li>
</ul>
:ET