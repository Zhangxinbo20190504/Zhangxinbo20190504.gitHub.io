I"ºe<h3 id="èƒŒæ™¯">èƒŒæ™¯</h3>

<p>åœ¨Djangoå¼€å‘ä¸­ç»å¸¸æœ‰è®¸å¤šè€—æ—¶çš„ä»»åŠ¡ï¼Œå¦‚è°ƒç”¨ç¬¬ä¸‰æ–¹æ¥å£ï¼Œé‚®ä»¶/çŸ­ä¿¡å‘é€ç­‰ç­‰ï¼Œä¸ºäº†ç¼©çŸ­è¯·æ±‚çš„å“åº”æ—¶é—´ï¼Œæœ€å¥½æŠŠè¿™äº›ä»»åŠ¡åšæˆå¼‚æ­¥ä»»åŠ¡ï¼Œè¿˜æœ‰ä¸€äº›ä»»åŠ¡éœ€è¦å‘¨æœŸæ‰§è¡Œï¼Œå¦‚æ•°æ®ç¼“å­˜çš„æ¸…ç†ï¼Œå¤‡ä»½ç­‰å·¥ä½œï¼Œä¸ºäº†å®Œæˆä¸Šè¿°éœ€æ±‚ï¼Œéœ€è¦å€ŸåŠ©ä¸€ä¸ªå·¥å…·ã€‚</p>

<p>celeryæ˜¯ä¸€ä¸ªé«˜æ•ˆçš„å¼‚æ­¥æ¶ˆæ¯å¤„ç†æ¡†æ¶ï¼Œä»…éœ€è¦ç®€å•çš„é…ç½®å°±å¯ä»¥è½»æ¾å¸®æˆ‘ä»¬å®ç°å¼‚æ­¥ä»»åŠ¡å’Œå®šæ—¶ä»»åŠ¡</p>

<p>celeryé€šè¿‡ä¸­é—´äºº(Brokerï¼Œé€šå¸¸é€‰æ‹©rabbitMQæˆ–è€…redis)å°†å®¢æˆ·ç«¯å‘å‡ºçš„æ¶ˆæ¯è½¬äº¤ç»™celry workeræ¥å¤„ç†ã€‚</p>

<p>æœ¬æ–‡ä»‹ç»äº†ä»¥ rabbitmqä½œä¸ºä¸­é—´äººåœ¨djangoä¸­é›†æˆceleryçš„æ–¹æ³•</p>

<h3 id="å®‰è£…celery">å®‰è£…celery</h3>

<blockquote>
  <p>Django ç‰ˆæœ¬3.2</p>
</blockquote>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>pip3 <span class="nb">install </span><span class="nv">celery</span><span class="o">==</span>5.0.5
pip3 <span class="nb">install </span>django-celery-beat<span class="o">==</span>2.2.0
pip3 <span class="nb">install </span>django-celery-results<span class="o">==</span>2.0.1
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="å®‰è£…rabbitmq">å®‰è£…rabbitmq</h3>

<blockquote>
  <p>ä¹Ÿå¯ä»¥é€‰æ‹©redisä½œä¸ºä¸­é—´äºº</p>
</blockquote>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>apt-get <span class="nb">install </span>rabbitmq-server
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ–°å¢ç”¨æˆ·</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>rabbitmqctl add_user ci ci
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æŸ¥çœ‹ç”¨æˆ·</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>rabbitmqctl list_users
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è®¾ç½®ç®¡ç†å‘˜</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>rabbitmqctl set_user_tags ci administrator
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ·»åŠ è™šæ‹Ÿç¯å¢ƒå¹¶è®¾ç½®æƒé™</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>rabbitmqctl add_vhost ci_backend
rabbitmqctl set_permissions <span class="nt">-p</span> ci_backend ci <span class="s2">".*"</span> <span class="s2">".*"</span> <span class="s2">".*"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>é‡å¯</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>rabbitmqctl stop
rabbitmq-server restart
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="å®ç°å¼‚æ­¥ä»»åŠ¡">å®ç°å¼‚æ­¥ä»»åŠ¡</h3>

<p>åœ¨ settings.py INSTALLED_APPS ä¸­åŠ å…¥celeryåº”ç”¨</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">...</span>
    <span class="s">'celery'</span><span class="p">,</span>
    <span class="s">'django_celery_beat'</span><span class="p">,</span>
    <span class="s">'django_celery_results'</span><span class="p">,</span>
   	<span class="p">...</span>
<span class="p">]</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ‰§è¡Œ</p>

<blockquote>
  <p>æ‰§è¡Œå®Œååº”è¯¥å¯ä»¥åœ¨æ•°æ®åº“ä¸­çœ‹åˆ°æ–°å¢äº†å…³äºceleryçš„æ•°æ®è¡¨</p>
</blockquote>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>python3 manage.py makemigrations
python3 manage.py migrate
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åœ¨ settings.py å¢åŠ celeryç›¸å…³é…ç½®</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="c1"># *celeyé…ç½®
</span><span class="n">CELERY_ENABLE_UTC</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">CELERY_TIMEZONE</span> <span class="o">=</span> <span class="s">"Asia/Shanghai"</span>
<span class="n">CELERY_TASK_TRACK_STARTED</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">CELERY_TASK_TIME_LIMIT</span> <span class="o">=</span> <span class="mi">30</span> <span class="o">*</span> <span class="mi">600</span>
<span class="n">CELERY_RESULT_BACKEND</span> <span class="o">=</span> <span class="s">'django-db'</span>
<span class="n">CELERYD_TASK_TIME_LIMIT</span> <span class="o">=</span> <span class="mi">86400</span><span class="o">/</span><span class="mi">4</span>
<span class="n">CELERYD_TASK_SOFT_TIME_LIMIT</span> <span class="o">=</span> <span class="mi">86400</span><span class="o">/</span><span class="mi">4</span>
<span class="n">CELERY_IGNORE_RESULT</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">CELERY_BROKER_URL</span> <span class="o">=</span> <span class="s">'amqp://ci:ci@172.16.20.200/ci_backend'</span>
<span class="n">CELERY_ACCEPT_CONTENT</span> <span class="o">=</span> <span class="p">[</span><span class="s">'application/json'</span><span class="p">,</span> <span class="p">]</span>
<span class="n">CELERY_TASK_SERIALIZER</span> <span class="o">=</span> <span class="s">'json'</span>
<span class="n">CELERY_RESULT_SERIALIZER</span> <span class="o">=</span> <span class="s">'json'</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åœ¨settings.pyåŒçº§å¢åŠ  <strong>celery.py</strong>æ–‡ä»¶</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span><span class="p">,</span> <span class="n">platforms</span>
<span class="kn">from</span> <span class="nn">celery.schedules</span> <span class="kn">import</span> <span class="n">crontab</span>
<span class="kn">from</span> <span class="nn">kombu</span> <span class="kn">import</span> <span class="n">Exchange</span><span class="p">,</span> <span class="n">Queue</span>

<span class="c1"># set the default Django settings module for the 'celery' program.
</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">'DJANGO_SETTINGS_MODULE'</span><span class="p">,</span> <span class="s">'mysite.settings'</span><span class="p">)</span>

<span class="c1"># ä½¿ç”¨rootæ‰§è¡Œceleryé¡»é…ç½®æ­¤é¡¹ï¼Œä½†æ˜¯åç»­celeryå¯åŠ¨æ—¶ä¾ç„¶ä¼šæœ‰warning
</span><span class="n">platforms</span><span class="p">.</span><span class="n">C_FORCE_ROOT</span> <span class="o">=</span> <span class="bp">True</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s">'mysite'</span><span class="p">)</span>

<span class="n">app</span><span class="p">.</span><span class="n">config_from_object</span><span class="p">(</span><span class="s">'django.conf:settings'</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s">'CELERY'</span><span class="p">)</span>
<span class="n">app</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">task_default_queue</span> <span class="o">=</span> <span class="s">'default'</span>
<span class="n">app</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">task_default_exchange</span> <span class="o">=</span> <span class="s">'default'</span>
<span class="n">app</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">task_default_routing_key</span> <span class="o">=</span> <span class="s">'default'</span>
<span class="n">app</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">timezone</span> <span class="o">=</span> <span class="s">'Asia/Shanghai'</span>

<span class="c1"># Load task modules from all registered Django app configs.
</span><span class="n">app</span><span class="p">.</span><span class="n">autodiscover_tasks</span><span class="p">()</span>

<span class="n">default_exchange</span> <span class="o">=</span> <span class="n">Exchange</span><span class="p">(</span><span class="s">'default'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">'direct'</span><span class="p">)</span>

<span class="c1"># ä»»åŠ¡åˆ—è¡¨
</span><span class="n">app</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">task_queues</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">Queue</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s">'default'</span><span class="p">),</span> <span class="n">default_exchange</span><span class="p">,</span> <span class="n">routing_key</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="s">'default'</span><span class="p">)),</span>
<span class="p">)</span>

<span class="c1"># æµ‹è¯•
</span><span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">debug_task</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Request: {0!r}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">request</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä¿®æ”¹åŒçº§çš„ <strong>____init</strong><em>__</em>.py</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">unicode_literals</span>
<span class="kn">from</span> <span class="nn">.celery</span> <span class="kn">import</span> <span class="n">app</span> <span class="k">as</span> <span class="n">celery_app</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s">'celery_app'</span><span class="p">,)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åœ¨djangoçš„appæ–‡ä»¶å¤¹ä¸‹æ–°å»º tasks.py æ–‡ä»¶ï¼Œå¦‚ build_info/tasks.py</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">shared_task</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="o">@</span><span class="n">shared_task</span>
<span class="k">def</span> <span class="nf">test_timed_tasks</span><span class="p">():</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"----Tasks"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ­¤æ—¶å…³äºceleryçš„ä»»åŠ¡å°±å†™å¥½äº†ï¼Œä¸‹é¢å°±æ˜¯æ¿€åŠ¨äººå¿ƒçš„éƒ¨åˆ†äº†</p>

<p>å¤šå¼€å‡ ä¸ªç»ˆç«¯ï¼Œåœ¨ç¬¬ä¸€ä¸ªç»ˆç«¯ä¸­å¯åŠ¨celery</p>

<blockquote>
  <p>mysiteæ˜¯æˆ‘çš„celery appåå­—</p>
</blockquote>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">cd</span> &lt;your project path&gt; celery <span class="nt">-A</span> mysite worker <span class="nt">-l</span> info
</pre></td></tr></tbody></table></code></pre></div></div>

<p>çœ‹åˆ°å¦‚ä¸‹è¾“å‡ºï¼Œåˆ™è¡¨æ˜celeryå¯åŠ¨æ­£å¸¸</p>

<blockquote>
  <p>è§‚å¯Ÿ [tasks] æ˜¯å¦æ˜¯æˆ‘ä»¬å‰é¢æ³¨å†Œçš„ä¸¤ä¸ªfunction</p>

  <p>celery@sz-xinbo ready. æœ‰æ²¡æœ‰readyçš„è¿™å¥è¯</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre>/usr/local/lib/python3.8/dist-packages/celery/platforms.py:796: RuntimeWarning: You're running the worker with superuser privileges: this is
absolutely not recommended!

Please specify a different user using the --uid option.

User information: uid=0 euid=0 gid=0 egid=0

  warnings.warn(RuntimeWarning(ROOT_DISCOURAGED.format(

 -------------- celery@sz-xinbo v5.0.5 (singularity)
--- ***** -----
-- ******* ---- Linux-5.4.0-90-generic-x86_64-with-glibc2.29 2021-12-03 17:49:28
- *** --- * ---
- ** ---------- [config]
- ** ---------- .&gt; app:         mysite:0x7fddc40e3520
- ** ---------- .&gt; transport:   amqp://ci:**@172.16.20.200:5672/ci_backend
- ** ---------- .&gt; results:
- *** --- * --- .&gt; concurrency: 8 (prefork)
-- ******* ---- .&gt; task events: OFF (enable -E to monitor tasks in this worker)
--- ***** -----
 -------------- [queues]
                .&gt; default          exchange=default(direct) key=default


[tasks]
  . build_info.tasks.test_timed_tasks
  . mysite.celery.debug_task

[2021-12-03 17:49:29,154: INFO/MainProcess] Connected to amqp://ci:**@172.16.20.200:5672/ci_backend
[2021-12-03 17:49:29,170: INFO/MainProcess] mingle: searching for neighbors
[2021-12-03 17:49:30,204: INFO/MainProcess] mingle: all alone
[2021-12-03 17:49:30,228: INFO/MainProcess] celery@sz-xinbo ready.
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ­¤æ—¶æ–°å¼€å¦ä¸€ä¸ªç»ˆç«¯</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">cd</span> &lt;your project path&gt; python3 ./manage.py shell
</pre></td></tr></tbody></table></code></pre></div></div>

<p>é€šè¿‡delayçš„æ–¹å¼æ‰§è¡Œæˆ‘ä»¬åˆšæ‰æ³¨å†Œçš„function</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="o">&gt;&gt;&gt;</span> from build_info.tasks import <span class="k">*</span>
<span class="o">&gt;&gt;&gt;</span> res <span class="o">=</span> test_timed_tasks.delay<span class="o">()</span>
<span class="o">&gt;&gt;&gt;</span> res
&lt;AsyncResult: 2de017ff-e0b9-4674-bf4a-b9942f075e66&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¯ä»¥å‘ç°æ‰§è¡Œåæœ‰ä¸€ä¸ªè¿”å›çš„ä»»åŠ¡idï¼Œæ­¤æ—¶è§‚å¯Ÿceleryç•Œé¢ï¼Œä¼šçœ‹åˆ°å·²ç»æ”¶åˆ°ä»»åŠ¡ï¼Œå¹¶åœ¨æˆ‘ä»¬çš„å»¶æ—¶å®Œæˆåæ˜¾ç¤ºä»»åŠ¡æˆåŠŸæ‰§è¡Œ</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="o">[</span>2021-12-03 17:50:06,661: INFO/MainProcess] Received task: build_info.tasks.test_timed_tasks[2de017ff-e0b9-4674-bf4a-b9942f075e66]
<span class="o">[</span>2021-12-03 17:51:46,732: WARNING/ForkPoolWorker-8] <span class="nt">----Tasks</span>
<span class="o">[</span>2021-12-03 17:51:46,752: INFO/ForkPoolWorker-8] Task build_info.tasks.test_timed_tasks[2de017ff-e0b9-4674-bf4a-b9942f075e66] succeeded <span class="k">in </span>100.08967352099717s: None
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åˆ°æ­¤ï¼Œé€šè¿‡celeryçš„å¼‚æ­¥ä»»åŠ¡é…ç½®å°±æˆåŠŸäº†</p>

<h3 id="å®ç°å®šæ—¶ä»»åŠ¡">å®ç°å®šæ—¶ä»»åŠ¡</h3>

<p>é€šè¿‡celeryè¿˜å¯ä»¥å®ç°å®šæ—¶ä»»åŠ¡ï¼Œä¾ç„¶ä»¥ä¸Šæ–‡æ–°å»ºçš„ä»»åŠ¡build_info/tasks.py ä¸­çš„ test_timed_tasks ä¸ºä¾‹ï¼Œæˆ‘ä»¬å¸Œæœ›å®ƒéš”ä¸€æ®µæ—¶é—´å°±æ‰§è¡Œä¸€æ¬¡</p>

<p>åœ¨celery.pyä¸­æ–°å¢å®šæ—¶ä»»åŠ¡</p>

<blockquote>
  <p>é€šè¿‡ crontab è®¾å®šæ¯2åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡</p>
</blockquote>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">celery.schedules</span> <span class="kn">import</span> <span class="n">crontab</span>

<span class="n">app</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">beat_schedule</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'tests'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'task'</span><span class="p">:</span> <span class="s">'build_info.tasks.test_timed_tasks'</span><span class="p">,</span>
        <span class="s">'schedule'</span><span class="p">:</span><span class="n">crontab</span><span class="p">(</span><span class="n">minute</span><span class="o">=</span><span class="s">"*/2"</span><span class="p">),</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¯åŠ¨django</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>python3 manage.py runserver &lt;your ip&gt;:&lt;your port&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ–°å¼€ä¸€ä¸ªç»ˆç«¯ï¼Œå¯åŠ¨worker</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">cd</span> &lt;your project path&gt; celery <span class="nt">-A</span> mysite worker <span class="nt">-l</span> info
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ–°å¼€ä¸€ä¸ªç»ˆç«¯ï¼Œå¯åŠ¨celery beat</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">cd</span> &lt;your project path&gt; celery <span class="nt">-A</span> mysite beat <span class="nt">-l</span> INFO
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä¼šçœ‹åˆ°å‘¨æœŸæ€§çš„ä»»åŠ¡å‘é€</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre>celery beat v5.0.5 <span class="o">(</span>singularity<span class="o">)</span> is starting.
__    -    ... __   -        _
LocalTime -&gt; 2021-12-03 17:18:38
Configuration -&gt;
    <span class="nb">.</span> broker -&gt; amqp://ci:<span class="k">**</span>@172.16.20.200:5672/ci_backend
    <span class="nb">.</span> loader -&gt; celery.loaders.app.AppLoader
    <span class="nb">.</span> scheduler -&gt; celery.beat.PersistentScheduler
    <span class="nb">.</span> db -&gt; celerybeat-schedule
    <span class="nb">.</span> logfile -&gt; <span class="o">[</span>stderr]@%INFO
    <span class="nb">.</span> maxinterval -&gt; 5.00 minutes <span class="o">(</span>300s<span class="o">)</span>
<span class="o">[</span>2021-12-03 17:18:38,148: INFO/MainProcess] beat: Starting...
<span class="o">[</span>2021-12-03 17:20:00,089: INFO/MainProcess] Scheduler: Sending due task tests <span class="o">(</span>build_info.tasks.test_timed_tasks<span class="o">)</span>
<span class="o">[</span>2021-12-03 17:22:00,076: INFO/MainProcess] Scheduler: Sending due task tests <span class="o">(</span>build_info.tasks.test_timed_tasks<span class="o">)</span>
<span class="o">[</span>2021-12-03 17:24:00,092: INFO/MainProcess] Scheduler: Sending due task tests <span class="o">(</span>build_info.tasks.test_timed_tasks<span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åŒæ—¶åœ¨workerç»ˆç«¯çœ‹åˆ°ä»»åŠ¡æ‰§è¡Œ</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="o">[</span>2021-12-03 17:20:09,886: INFO/MainProcess] Received task: build_info.tasks.test_timed_tasks[ebabbd97-4636-45b9-afce-bf6cd6a23e35]
<span class="o">[</span>2021-12-03 17:21:49,964: WARNING/ForkPoolWorker-8] <span class="nt">----Tasks</span>
<span class="o">[</span>2021-12-03 17:21:49,973: INFO/ForkPoolWorker-8] Task build_info.tasks.test_timed_tasks[ebabbd97-4636-45b9-afce-bf6cd6a23e35] succeeded <span class="k">in </span>100.08622614399064s: None
<span class="o">[</span>2021-12-03 17:22:00,094: INFO/MainProcess] Received task: build_info.tasks.test_timed_tasks[c31f1cc3-640d-413c-b535-ee38600b64d0]
<span class="o">[</span>2021-12-03 17:23:40,128: WARNING/ForkPoolWorker-8] <span class="nt">----Tasks</span>
<span class="o">[</span>2021-12-03 17:23:40,155: INFO/ForkPoolWorker-8] Task build_info.tasks.test_timed_tasks[c31f1cc3-640d-413c-b535-ee38600b64d0] succeeded <span class="k">in </span>100.05949019198306s: None
...
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ­¤æ—¶å®šæ—¶ä»»åŠ¡é…ç½®æˆåŠŸ</p>

<h3 id="éƒ¨ç½²é›†æˆ">éƒ¨ç½²é›†æˆ</h3>

<p>Djangoæ­£å¼éƒ¨ç½²æ—¶é‡‡ç”¨ç»ˆç«¯çš„æ–¹å¼å¯åŠ¨celeryè‚¯å®šæ˜¯ä¸ç°å®çš„ï¼Œéœ€è¦ç”¨åˆ°celeryçš„å®ˆæŠ¤è¿›ç¨‹multi</p>

<blockquote>
  <p>é€šè¿‡ â€“beat å¯åŠ¨å®šæ—¶ä»»åŠ¡</p>

  <p>ä¿è¯pidfileè·¯å¾„ å’Œ logfile è·¯å¾„å­˜åœ¨ä¸”å…·æœ‰å†™æƒé™</p>

  <table>
    <tbody>
      <tr>
        <td>å¯åŠ¨åé€šè¿‡ ps aux</td>
        <td>grep celery å¯ä»¥æŸ¥çœ‹åˆ°ä¸ concurrency æ•°ç›®ç›¸ç­‰çš„è¿›ç¨‹</td>
      </tr>
    </tbody>
  </table>
</blockquote>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">cd</span> &lt;your project path&gt;
celery multi start w1 <span class="nt">-A</span> mysite <span class="nt">-l</span> info <span class="nt">--beat</span> <span class="nt">--pidfile</span><span class="o">=</span>/var/run/celery/%n.pid <span class="nt">--logfile</span><span class="o">=</span>/var/log/celery/%n%I.log <span class="nt">--concurrency</span><span class="o">=</span>15
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ€æ‰ celery å®ˆæŠ¤è¿›ç¨‹çš„æ–¹æ³•</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ps <span class="nt">-ef</span> | <span class="nb">grep </span>celery | <span class="nb">awk</span> <span class="s1">'{print $2}'</span> | xargs <span class="nb">kill</span> <span class="nt">-9</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h3>

<ul>
  <li>Djangoä½¿ç”¨Celery demoçš„å®˜æ–¹ <a href="https://github.com/celery/celery/tree/master/examples/django/">githubåœ°å€</a></li>
  <li><a href="https://www.celerycn.io/">Celeryä¸­æ–‡æ‰‹å†Œ</a></li>
  <li><a href="https://docs.celeryproject.org/en/stable/">Celeryå®˜æ–¹æ–‡æ¡£</a></li>
</ul>

:ET